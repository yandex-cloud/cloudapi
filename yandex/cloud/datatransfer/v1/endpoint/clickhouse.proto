syntax = "proto3";

package yandex.cloud.datatransfer.v1.endpoint;

option go_package = "github.com/yandex-cloud/go-genproto/yandex/cloud/datatransfer/v1/endpoint;endpoint";
option java_package = "yandex.cloud.api.datatransfer.v1.endpoint";
option csharp_namespace = "Yandex.Cloud.Datatransfer.V1.EndPoint"; // there is a clash with class Endpoint in namespace Yandex.Cloud.Datatransfer.V1

import "google/protobuf/empty.proto";
import "yandex/cloud/datatransfer/v1/endpoint/common.proto";

enum ClickhouseCleanupPolicy {
    CLICKHOUSE_CLEANUP_POLICY_UNSPECIFIED = 0;
    CLICKHOUSE_CLEANUP_POLICY_DISABLED = 1;
    CLICKHOUSE_CLEANUP_POLICY_DROP = 2;
    CLICKHOUSE_CLEANUP_POLICY_TRUNCATE = 3;
}
message ClickhouseShard {
    string name = 1;
    repeated string hosts = 2;
}
message OnPremiseClickhouse {
    reserved 2, 5 to 7;
    repeated ClickhouseShard shards = 1;
    int64 http_port = 3;
    int64 native_port = 4;
    // TLS settings for server connection. Disabled by default
    TLSMode tls_mode = 8;
}
message ClickhouseConnectionOptions {
    reserved 1, 4;
    oneof address {
        // Connection settings of the on-premise ClickHouse server
        OnPremiseClickhouse on_premise = 2;
        // Get ClickHouse installation params and credentials from Connection Manager
        ConnectionManagerConnection connection_manager_connection = 3;
        // Identifier of the Managed ClickHouse cluster
        string mdb_cluster_id = 5;
    }
    // User for database access. Required unless connection_manager_connection is used
    string user = 6;
    // Password for the database access
    Secret password = 7;
    // Database name
    string database = 8;
}
message ClickhouseConnection {
    oneof connection {
        ClickhouseConnectionOptions connection_options = 1;
    }
}
message ClickhouseSharding {
    message ColumnValueHash {
        // The name of the column to calculate hash from
        string column_name = 1;
    }
    message ColumnValueMapping {
        message ValueToShard {
            // The value of the column. Currently only the string columns are supported
            ColumnValue column_value = 1;
            // The name of the shard into which all the rows with the specified `column_value`
            // will be written
            string shard_name = 2;
        }
        // The name of the column to inspect when deciding the shard to chose for an
        // incoming row
        string column_name = 1;
        // The mapping of the specified column values to the shard names
        repeated ValueToShard mapping = 2;
    }
    oneof sharding {
        // Shard data by the hash value of the specified column
        ColumnValueHash column_value_hash = 1;
        // A custom shard mapping by the value of the specified column
        ColumnValueMapping custom_mapping = 2;
        // Shard data by ID of the transfer
        google.protobuf.Empty transfer_id = 3;
        // Distribute incoming rows between ClickHouse shards in a round-robin manner.
        // Specify as an empty block to enable
        google.protobuf.Empty round_robin = 4;
    }
}
// Settings specific to the ClickHouse source endpoint
message ClickhouseSource {
    reserved 2 to 6;
    // Connection settings
    ClickhouseConnection connection = 1;
    // White list of tables for replication. If none or empty list is presented - will
    // replicate all tables. Can contain * patterns.
    repeated string include_tables = 7;
    // Exclude list of tables for replication. If none or empty list is presented -
    // will replicate all tables. Can contain * patterns.
    repeated string exclude_tables = 8;
    // Identifier of the Yandex Cloud VPC subnetwork to user for accessing the
    // database.
    // If omitted, the server has to be accessible via Internet
    string subnet_id = 9;
    // List of security groups that the transfer associated with this endpoint should
    // use
    repeated string security_groups = 10;
    // Name of the ClickHouse cluster. For Managed ClickHouse that is name of
    // ShardGroup or managed cluster ID by default
    string clickhouse_cluster_name = 11;
}
// Settings specific to the ClickHouse target endpoint
message ClickhouseTarget {
    reserved 1, 3 to 11, 13 to 16, 18 to 20, 23 to 34, 36 to 49;
    // Connection settings
    ClickhouseConnection connection = 2;
    // Identifier of the Yandex Cloud VPC subnetwork to user for accessing the
    // database.
    // If omitted, the server has to be accessible via Internet
    string subnet_id = 12;
    // Table renaming rules in target
    repeated AltName alt_names = 17;
    // How to clean collections when activating the transfer. One of
    // `CLICKHOUSE_CLEANUP_POLICY_DISABLED` or `CLICKHOUSE_CLEANUP_POLICY_DROP`
    ClickhouseCleanupPolicy cleanup_policy = 21;
    // Shard selection rules for the data being transferred
    ClickhouseSharding sharding = 22;
    // Whether can change table schema if schema changed on source
    bool is_schema_migration_disabled = 35;
    // Name of the ClickHouse cluster. For Managed ClickHouse that is name of
    // ShardGroup or managed cluster ID by default.
    string clickhouse_cluster_name = 50;
    // List of security groups that the transfer associated with this endpoint should
    // use
    repeated string security_groups = 51;
}
